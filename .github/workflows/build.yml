name: Build TWRP for Realme 11x 5G

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    # Step 1: Checkout YOUR repository (with device tree)
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Step 2: Install tools
    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y git repo python3 openjdk-11-jdk abootimg
        
    # Step 3: Setup workspace
    - name: Setup workspace
      run: |
        mkdir -p twrp
        cd twrp
        
    # Step 4: Initialize TWRP source
    - name: Initialize TWRP
      run: |
        cd twrp
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1 --depth=100
        
    # Step 5: Sync source
    - name: Sync source
      run: |
        cd twrp
        repo sync -c -j4 --force-sync --no-clone-bundle --optimized-fetch
        
    # Step 6: Copy device tree from YOUR repository
    - name: Copy device tree
      run: |
        # Copy device tree from checked out repo to twrp directory
        mkdir -p twrp/device/realme/RE5C6CL1
        cp -r device/realme/RE5C6CL1/* twrp/device/realme/RE5C6CL1/
        
    # Step 7: Download and EXTRACT kernel from boot.img
    - name: Download and extract kernel
      run: |
        cd twrp/device/realme/RE5C6CL1
        
        echo "=== Downloading boot.img ==="
        # Download from your Google Drive
        wget -q "https://drive.google.com/uc?export=download&id=1i1pVhk_J7et3cQlwkffVO_WdcQsBKvGI" -O boot.img
        
        echo "=== Extracting kernel ==="
        echo "File type: $(file boot.img)"
        
        # Extract kernel from boot.img
        abootimg -x boot.img
        
        echo "=== Looking for kernel ==="
        ls -la
        
        # The kernel could be named: zImage, Image.gz, or Image
        if [ -f "zImage" ]; then
          echo "Found: zImage"
          cp zImage kernel
        elif [ -f "Image.gz" ]; then
          echo "Found: Image.gz"
          cp Image.gz kernel
        elif [ -f "Image" ]; then
          echo "Found: Image"
          cp Image kernel
        else
          echo "No kernel found. Files extracted:"
          ls -la
          # Fallback: use boot.img as kernel
          cp boot.img kernel
        fi
        
        echo "=== Final kernel ==="
        ls -lh kernel
        file kernel || true
        
    # Step 8: Build TWRP
    - name: Build TWRP
      run: |
        cd twrp
        
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch twrp_RE5C6CL1-eng
        
        echo "=== Building TWRP ==="
        make recoveryimage -j1 2>&1 | tee build.log
        
    # Step 9: Check result
    - name: Check build
      run: |
        cd twrp
        
        if [ -f "out/target/product/RE5C6CL1/recovery.img" ]; then
          echo "✅ TWRP BUILT SUCCESSFULLY!"
          echo "Size: $(ls -lh out/target/product/RE5C6CL1/recovery.img)"
        else
          echo "❌ Build failed"
          echo "Last errors:"
          tail -50 build.log | grep -i "error\|failed" || tail -50 build.log
          exit 1
        fi
        
    # Step 10: Upload TWRP
    - name: Upload TWRP
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-Realme-11x
        path: twrp/out/target/product/RE5C6CL1/recovery.img
