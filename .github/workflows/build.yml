name: Build TWRP for Realme 11x 5G

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
    - name: Checkout device tree
      uses: actions/checkout@v4
      
    - name: Install minimal dependencies
      run: |
        sudo apt update
        sudo apt install -y git repo python3 openjdk-11-jdk ccache
        
    - name: Initialize TWRP source
      run: |
        mkdir -p twrp
        cd twrp
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-12.1
        
    - name: Sync source code
      run: |
        cd twrp
        repo sync -c -j4 --force-sync --no-clone-bundle --optimized-fetch
        
    - name: Copy device tree
      run: |
        mkdir -p twrp/device/realme/RE5C6CL1
        cp -r device/realme/RE5C6CL1/* twrp/device/realme/RE5C6CL1/
        
    - name: Download kernel from Google Drive
      run: |
        cd twrp/device/realme/RE5C6CL1
        
        # Install gdown
        pip3 install gdown
        
        # Download your kernel (67MB)
        echo "Downloading kernel..."
        gdown "https://drive.google.com/uc?id=1jZHwXptEP2YjM0PBDsbXNyPyRG3bkVuW" -O kernel
        
        # Verify
        if [ -f "kernel" ]; then
          echo "‚úÖ Kernel downloaded: $(ls -lh kernel)"
        else
          echo "‚ùå Kernel download failed"
          # Create dummy kernel for testing
          dd if=/dev/zero of=kernel bs=1M count=10
        fi
        
    - name: Pre-build fixes
      run: |
        cd twrp
        
        # Create necessary directories to prevent errors
        mkdir -p out/target/product/RE5C6CL1/root/vendor
        mkdir -p out/target/product/RE5C6CL1/recovery/root/vendor
        
    - name: Build TWRP
      run: |
        cd twrp
        
        # Critical environment variables
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        
        # Setup environment
        source build/envsetup.sh
        
        # Select device
        lunch twrp_RE5C6CL1-eng
        
        echo "=== Building TWRP ==="
        
        # Build with single thread first (more stable)
        make vendorbootimage -j1 2>&1 | tee build.log
        
        # Check if successful
        if [ ${PIPESTATUS[0]} -eq 0 ] && [ -f "out/target/product/RE5C6CL1/recovery.img" ]; then
          echo "‚úÖ BUILD SUCCESS!"
        else
          echo "‚ö†Ô∏è  First attempt failed, trying with more threads..."
          make recoveryimage -j$(nproc --all) 2>&1 | tee -a build.log
        fi
        
    - name: Verify build
      run: |
        cd twrp
        
        if [ -f "out/target/product/RE5C6CL1/recovery.img" ]; then
          echo "üéâ TWRP BUILD COMPLETE!"
          echo "Size: $(ls -lh out/target/product/RE5C6CL1/recovery.img)"
          echo "Type: $(file out/target/product/RE5C6CL1/recovery.img 2>/dev/null || echo 'Android recovery image')"
        else
          echo "‚ùå Build failed - no recovery image"
          echo "Checking for errors..."
          tail -100 build.log | grep -i "error\|failed" || true
          exit 1
        fi
        
    - name: Upload TWRP
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-Realme-11x-5G
        path: twrp/out/target/product/RE5C6CL1/recovery.img
        
    - name: Upload logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: twrp/build.log
