name: Build TWRP vendor_boot for Realme 11x 5G

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    # =====================================================
    # Checkout device tree repository
    # =====================================================
    - name: Checkout device tree
      uses: actions/checkout@v4

    # =====================================================
    # Install build dependencies
    # =====================================================
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git repo python3 python3-pip \
          openjdk-11-jdk \
          bc bison build-essential \
          curl flex g++-multilib gcc-multilib \
          gnupg gperf imagemagick \
          lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev liblz4-tool libncurses5 \
          libncurses5-dev libsdl1.2-dev \
          libssl-dev libxml2 libxml2-utils \
          lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev \
          ccache

    # =====================================================
    # Initialize TWRP source (Android 12 base)
    # =====================================================
    - name: Initialize TWRP source
      run: |
        mkdir -p twrp
        cd twrp
        repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b twrp-14.1

    # =====================================================
    # Sync source code
    # =====================================================
    - name: Sync source
      run: |
        cd twrp
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --optimized-fetch

    # =====================================================
    # Copy device tree
    # =====================================================
    - name: Copy device tree
      run: |
        mkdir -p twrp/device/realme/RE5C6CL1
        cp -r device/realme/RE5C6CL1/* twrp/device/realme/RE5C6CL1/

    # =====================================================
    # Download prebuilt kernel
    # =====================================================
    - name: Download kernel
      run: |
        cd twrp/device/realme/RE5C6CL1
        pip3 install --user gdown

        echo "Downloading kernel..."
        gdown "https://drive.google.com/uc?id=1jZHwXptEP2YjM0PBDsbXNyPyRG3bkVuW" -O kernel

        if [ ! -s kernel ]; then
          echo "❌ Kernel download failed or empty"
          exit 1
        fi

        chmod +x kernel
        ls -lh kernel

    # =====================================================
    # Build TWRP vendor_boot (Android 14)
    # =====================================================
    - name: Build vendor_boot
      run: |
        cd twrp

        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C

        source build/envsetup.sh
        lunch twrp_RE5C6CL1-eng

        echo "=== Building TWRP vendor_boot (Android 14) ==="
        make vendorbootimage -j$(nproc --all) 2>&1 | tee build.log

        if [ ! -f "out/target/product/RE5C6CL1/vendor_boot.img" ]; then
          echo "❌ vendor_boot.img not generated"
          exit 1
        fi

        echo "✅ vendor_boot.img built successfully"
        ls -lh out/target/product/RE5C6CL1/vendor_boot.img

    # =====================================================
    # Verify output
    # =====================================================
    - name: Verify vendor_boot
      run: |
        cd twrp

        file out/target/product/RE5C6CL1/vendor_boot.img || true

        echo "Checking for TWRP strings..."
        strings out/target/product/RE5C6CL1/vendor_boot.img | grep -i "twrp\|teamwin\|recovery" || true

    # =====================================================
    # Upload artifact
    # =====================================================
    - name: Upload TWRP vendor_boot
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-vendor_boot-Realme-11x-5G
        path: twrp/out/target/product/RE5C6CL1/vendor_boot.img

    # =====================================================
    # Upload logs if build fails
    # =====================================================
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: twrp/build.log
